---
title: "Suclustering_analysis_CA_clusters"
author: "Adrian Salas"
date: "4/19/2020"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

The next steps are used for comparing cell proportions between sub-clusters per condition as well for DEG analysis and Over-representation test analysis.

Loading the environment where the data was stored:
```{r}
load("~/Documents/Bioinformatic_Analysis/R_workspaces_sc/Base_Markdowns.RData", verbose = T)
```


Plot the cells distributions between the different sub-clusters pero condition
```{r, echo=TRUE}
library(ggplot2)
subcluster <- rep(c("1: Pou3f1 not enriched","2: Pou3f1 enriched","3: Pou3f1 not enriched"), 3)
condition <- c(rep("Control" , 3), rep("KO 1", 3), rep("KO 2", 3))  
value <- c(81,27,2,78,57,2,96,61,2)
total <- c(rep(110, 3), rep(137, 3), rep(159,3))
percent <- rep(1, 9)
data <- data.frame(subcluster,condition,value, total, percent)

for (i in 1:dim(data)[1]) {
  data$percent <- data$value/data$total * 100
}

ggplot(data, aes(fill=subcluster, y=percent, x=condition)) + 
  geom_bar(position="dodge", stat="identity") + theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(), 
  panel.background = element_blank(), axis.line = element_line(colour = "black")) + labs(x= "Sample", y= "Cells per cluster (%)") +
  scale_fill_manual(values=c("#0000FFFF", "#00FF00FF", "#FF0000FF")) +ylim(0,100)


```

Generate a table with the cell numbers per cluster per condition
```{r}
cl <- sc@cpart # This slot stores the "Final Clusters" information after outlier analysis
df_cl <- data.frame(names= names(cl), cluster=cl)
df_cl$condition <- substr(df_cl$names, start = 0, stop = 4)
table_clusters <-table(df_cl$condition, df_cl$cluster)
table_clusters

```

Performing the Fisher exact test for checking significant changes in cell proportions between conditions.
Divide the table in subtables for the comparisons 1 vs 1.

```{r}
table_clusters1 <- table_clusters[1:2, ]
table_clusters1
table_clusters2 <- table_clusters[c(1,3), ]
table_clusters2
table_clusters3 <- table_clusters[2:3, ]
table_clusters3
```

Store the number of cells as a list and run the fisher exact test as a batch for each conditions comparison.
```{r}
# Control vs cKO813
dataLIST1 <- list()
data <- data.frame("CellsIn"= c(1,1), "CellsOut"= c(1,1))

 for (j in 1:dim(table_clusters1)[2]){
    for (i in 1:dim(table_clusters1)[1]) {
      data$CellsIn[i] <- table_clusters1[i,j]
      data$CellsOut[i] <- (sum(table_clusters1[i,]) - table_clusters1[i,j])
      dataLIST1[[j]] <- data
      rownames(dataLIST1[[j]]) <- rownames(table_clusters1)
  }
}

FISHER_RESULTS1 <- list()

for (i in 1:length(dataLIST1)) {
  FISHER_RESULTS1[[i]] <- fisher.test(dataLIST1[[i]])
}

# Control vs cKO814
dataLIST2 <- list()
data <- data.frame("CellsIn"= c(1,1), "CellsOut"= c(1,1))

 for (j in 1:dim(table_clusters2)[2]){
    for (i in 1:dim(table_clusters2)[1]) {
      data$CellsIn[i] <- table_clusters2[i,j]
      data$CellsOut[i] <- (sum(table_clusters2[i,]) - table_clusters2[i,j])
      dataLIST2[[j]] <- data
      rownames(dataLIST2[[j]]) <- rownames(table_clusters2)
  }
}

FISHER_RESULTS2 <- list()

for (i in 1:length(dataLIST2)) {
  FISHER_RESULTS2[[i]] <- fisher.test(dataLIST2[[i]])
}

# cKO813 vs cKO814
dataLIST3 <- list()
data <- data.frame("CellsIn"= c(1,1), "CellsOut"= c(1,1))

 for (j in 1:dim(table_clusters3)[2]){
    for (i in 1:dim(table_clusters3)[1]) {
      data$CellsIn[i] <- table_clusters3[i,j]
      data$CellsOut[i] <- (sum(table_clusters3[i,]) - table_clusters3[i,j])
      dataLIST3[[j]] <- data
      rownames(dataLIST3[[j]]) <- rownames(table_clusters3)
  }
}

FISHER_RESULTS3 <- list()

for (i in 1:length(dataLIST3)) {
  FISHER_RESULTS3[[i]] <- fisher.test(dataLIST3[[i]])
}

```

Perform the bonferroni correction of the p values for accounting the multiple comparisons.
```{r}
# C817 vs K813
pvalues1 <- list()
for (i in 1:length(FISHER_RESULTS1)) {
  pvalues1[i] <- FISHER_RESULTS1[[i]]$p.value
}
pvalues1 <- unlist(pvalues1)
# Adjusting the p value
pvalues1_adj <- p.adjust(pvalues1, method = "bonferroni")
# Checkign the padj that passed the threshold (<0.05)
pvalues1_adj < 0.05

# C817 vs K814
pvalues2 <- list()
for (i in 1:length(FISHER_RESULTS2)) {
  pvalues2[i] <- FISHER_RESULTS2[[i]]$p.value
}
pvalues2 <- unlist(pvalues2)
# Adjusting the p value
pvalues2_adj <- p.adjust(pvalues2, method = "bonferroni")
# Checkign the padj that passed the threshold (<0.05)
pvalues2_adj < 0.05

# K813 vs K814
pvalues3 <- list()
for (i in 1:length(FISHER_RESULTS3)) {
  pvalues3[i] <- FISHER_RESULTS3[[i]]$p.value
}
pvalues3 <- unlist(pvalues3)
# Adjusting the p value
pvalues3_adj <- p.adjust(pvalues3, method = "bonferroni")
# Checkign the padj that passed the threshold (<0.05)
pvalues3_adj < 0.05

# Check the clusters that remain significant when comparing Control vs each cKO after p value adjustment.
((pvalues1_adj < 0.05) & (pvalues2_adj < 0.05)) == TRUE
```


DEG analysis between sub-clusters using the **RaceID** built-in function.
```{r}
library(RaceID)
library(dplyr)
DEGsAll2 <- list()
for (i in 1:max(sc@cpart)) {
  
  DEGsAll2[[i]] <- clustdiffgenes(sc, i, pvalue = 1)
}

DEGsAll2FTD <- DEGsAll2
for (i in 1:length(DEGsAll2)) {
  DEGsAll2FTD[[i]]$gene <- rownames(DEGsAll2[[i]])
  DEGsAll2FTD[[i]]$log2FoldChange <- log2(DEGsAll2[[i]]$fc)
  DEGsAll2FTD[[i]] <- filter(DEGsAll2FTD[[i]], padj < 0.05)
  DEGsAll2FTD[[i]] <- DEGsAll2FTD[[i]][ , c(6,3,7,4,5)]
}

```

DEG analysis between conditions per sub-clusters using the **RaceID** built-in function.
```{r}
cellsInClCond <- list()
for (i in (1:max(sc@cpart))){
  cellsin <- names(sc@cpart[sc@cpart == i])
  cellsCont <- cellsin[grep("^C", cellsin)]
  cellscKO <- cellsin[grep("^K", cellsin)] 
  cellsInClCond[[i]] <- list(cellsCont, cellscKO)  
} 

DEG_all_Cond <- list()
for (i in 1:max(sc@cpart)){  
  if (length(cellsInClCond[[i]][[1]]) != 0 & length(cellsInClCond[[i]][[2]]) != 0) {
    A <- cellsInClCond[[i]][[1]] # control cells
    B <- cellsInClCond[[i]][[2]] # cKO cells
    DEG_all_Cond[[i]] <- diffexpnb(getfdata(sc, n=c(A,B)), A=A, B=B)
  }
  else
    DEG_all_Cond[[i]] <- "No DEGs computed"
}

# FIlter the DEGs based on a p value threshold (p < 0.05)
DEGCA1sub1condFTD <- DEG_all_Cond[[1]]$res[DEG_all_Cond[[1]]$res$padj < 0.05 , ]
DEGCA1sub2condFTD <- DEG_all_Cond[[2]]$res[DEG_all_Cond[[2]]$res$padj < 0.05 , ]
DEGCA1sub3condFTD <- DEG_all_Cond[[3]]$res[DEG_all_Cond[[3]]$res$padj < 0.05 , ]

```


Over-representation test for analysing the GO terms enriched in the subclusters.
```{r, echo=TRUE}
library(clusterProfiler)
library(org.Mm.eg.db)

# Define the 2 sub-clusters to compare
A <- names(sc@cpart)[sc@cpart == 1] 
B <- names(sc@cpart)[sc@cpart == 2]  # Cluster 2 is the one with higher expression of Pou3f1

# Compute DEG analysis and filter the result based on p value threshold
DEGCA1_1vs2 <- diffexpnb(getfdata(sc, n= c(A,B)), A=A, B=B)
DEGCA1_1vs2FTD <- DEGCA1_1vs2$res
DEGCA1_1vs2FTD$gene <- rownames(DEGCA1_1vs2FTD)
DEGCA1_1vs2FTD <- filter(DEGCA1_1vs2FTD, padj < 0.05)

# Perform the Over-representation test
AllgenesLog2FC <- as.numeric(DEGCA1_1vs2$res$log2FoldChange)
names(AllgenesLog2FC) <- rownames(DEGCA1_1vs2$res)

DEGCA1_1vs2_genes <- as.numeric(DEGCA1_1vs2FTD$log2FoldChange)
names(DEGCA1_1vs2_genes) <- DEGCA1_1vs2FTD$gene

egoCA1_1vs2 <- enrichGO(gene = names(DEGCA1_1vs2_genes), universe = names(AllgenesLog2FC), 
                        OrgDb = org.Mm.eg.db, ont = "MF", pAdjustMethod = "BH", pvalueCutoff = 0.01,
                        qvalueCutoff = 0.05, minGSSize = 10, maxGSSize = 500, keyType = "SYMBOL")

# Combine Go terms that share similarity of at least "cutoff"
egoCA1_1vs2Simplified <- simplify(egoCA1_1vs2, cutoff =0.8, by="p.adjust")

# Check some of the plots
emapplot(egoCA1_1vs2)
dotplot(egoCA1_1vs2)
goplot(egoCA1_1vs2)
barplot(egoCA1_1vs2)
cnetplot(egoCA1_1vs2)

```

Save the environment for the following analysis.
```{r}
save.image("~/Documents/Bioinformatic_Analysis/R_workspaces_sc/CA_Markdowns.RData")
```
