---
title: "Cell_Proportions_Fisher_Test"
author: "Adrian Salas"
date: "4/19/2020"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

Loading the environment where the data was stored:
```{r}
load("~/Documents/Bioinformatic_Analysis/R_workspaces_sc/Base_Markdowns.RData", verbose = T)
```

Generate a table with the cell numbers per cluster per condition
```{r}
cl <- sc@cpart # This slot stores the "Final Clusters" information after outlier analysis
names(cl) <- toupper(names(cl))
df_cl <- data.frame(names= names(cl), cluster=cl)
df_cl$condition <- substr(df_cl$names, start = 0, stop = 4)
table_clusters <-table(df_cl$condition, df_cl$cluster)
table_clusters

```

Transforming the cell numbers to percentages based on total number of cells per condition.
```{r}
sum_rows <- apply(table_clusters, 1, sum)
sum_rows <- as.table(sum_rows)
clus_cellsPerc <- apply(table_clusters, 2, function(x){x/sum_rows*100})

# Filtering the clusters with just one or 2 cells
clus_cellsPercFTD <- clus_cellsPerc[ , -c(19,22,24,26,27)]
clus_cellsPercFTD
```

Generating a barplot showing the cell proportions per cluster per condition.
```{r, echo=TRUE}
barplot(clus_cellsPercFTD, horiz = T, col = c("#bababa","#ca0020", "#f4a582"), border = "black", space = 0.3, legend= c("Control", "cKO 1", "cKO 2"), font.axis=2, xlab = "Percentage of cells")

```

Performing the Fisher exact test for checking significant changes in cell proportions between conditions.
Divide the table in subtables for the comparisons 1 vs 1.

```{r}
table_clusters1 <- table_clusters[1:2, ]
table_clusters1
table_clusters2 <- table_clusters[c(1,3), ]
table_clusters2
table_clusters3 <- table_clusters[2:3, ]
table_clusters3
```
Store the number of cells as a list and run the fisher exact test as a batch for each conditions comparison.
```{r}
# Control vs cKO813
dataLIST1 <- list()
data <- data.frame("CellsIn"= c(1,1), "CellsOut"= c(1,1))

 for (j in 1:dim(table_clusters1)[2]){
    for (i in 1:dim(table_clusters1)[1]) {
      data$CellsIn[i] <- table_clusters1[i,j]
      data$CellsOut[i] <- (sum(table_clusters1[i,]) - table_clusters1[i,j])
      dataLIST1[[j]] <- data
      rownames(dataLIST1[[j]]) <- rownames(table_clusters1)
  }
}

FISHER_RESULTS1 <- list()

for (i in 1:length(dataLIST1)) {
  FISHER_RESULTS1[[i]] <- fisher.test(dataLIST1[[i]])
}

# Control vs cKO814
dataLIST2 <- list()
data <- data.frame("CellsIn"= c(1,1), "CellsOut"= c(1,1))

 for (j in 1:dim(table_clusters2)[2]){
    for (i in 1:dim(table_clusters2)[1]) {
      data$CellsIn[i] <- table_clusters2[i,j]
      data$CellsOut[i] <- (sum(table_clusters2[i,]) - table_clusters2[i,j])
      dataLIST2[[j]] <- data
      rownames(dataLIST2[[j]]) <- rownames(table_clusters2)
  }
}

FISHER_RESULTS2 <- list()

for (i in 1:length(dataLIST2)) {
  FISHER_RESULTS2[[i]] <- fisher.test(dataLIST2[[i]])
}

# cKO813 vs cKO814
dataLIST3 <- list()
data <- data.frame("CellsIn"= c(1,1), "CellsOut"= c(1,1))

 for (j in 1:dim(table_clusters3)[2]){
    for (i in 1:dim(table_clusters3)[1]) {
      data$CellsIn[i] <- table_clusters3[i,j]
      data$CellsOut[i] <- (sum(table_clusters3[i,]) - table_clusters3[i,j])
      dataLIST3[[j]] <- data
      rownames(dataLIST3[[j]]) <- rownames(table_clusters3)
  }
}

FISHER_RESULTS3 <- list()

for (i in 1:length(dataLIST3)) {
  FISHER_RESULTS3[[i]] <- fisher.test(dataLIST3[[i]])
}

```

Perform the bonferroni correction of the p values for accounting the multiple comparisons.
```{r}
# C817 vs K813
pvalues1 <- list()
for (i in 1:length(FISHER_RESULTS1)) {
  pvalues1[i] <- FISHER_RESULTS1[[i]]$p.value
}
pvalues1 <- unlist(pvalues1)
# Adjusting the p value
pvalues1_adj <- p.adjust(pvalues1, method = "bonferroni")
# Checkign the padj that passed the threshold (<0.05)
pvalues1_adj < 0.05

# C817 vs K814
pvalues2 <- list()
for (i in 1:length(FISHER_RESULTS2)) {
  pvalues2[i] <- FISHER_RESULTS2[[i]]$p.value
}
pvalues2 <- unlist(pvalues2)
# Adjusting the p value
pvalues2_adj <- p.adjust(pvalues2, method = "bonferroni")
# Checkign the padj that passed the threshold (<0.05)
pvalues2_adj < 0.05

# K813 vs K814
pvalues3 <- list()
for (i in 1:length(FISHER_RESULTS3)) {
  pvalues3[i] <- FISHER_RESULTS3[[i]]$p.value
}
pvalues3 <- unlist(pvalues3)
# Adjusting the p value
pvalues3_adj <- p.adjust(pvalues3, method = "bonferroni")
# Checkign the padj that passed the threshold (<0.05)
pvalues3_adj < 0.05

# Check the clusters that remain significant when comparing Control vs each cKO after p value adjustment.
((pvalues1_adj < 0.05) & (pvalues2_adj < 0.05)) == TRUE
```

Save the environment for the following analysis.
```{r}
save.image("~/Documents/Bioinformatic_Analysis/R_workspaces_sc/Base_Markdowns.RData")
```
